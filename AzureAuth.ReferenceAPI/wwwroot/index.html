<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript">
        class JWTClient {
            #sessionServiceEndpoint; #jwt; #sessionIssuer;
            constructor(sessionServiceEndpoint) {
                this.#sessionServiceEndpoint = sessionServiceEndpoint;
            }

            async login(authJWT) {
                let fetchOptions = { credentials: "include" };
                if (!authJWT && this.#jwt) authJWT = this.#jwt;
                if (authJWT) fetchOptions.headers = { Authorization: "Bearer " + authJWT }
                
                return await fetch(this.#sessionServiceEndpoint + '/api/Login', fetchOptions)
                    .then(r => r.json()).then(jwt => this.#jwt = jwt.token)
                    .then(() => true).catch(() => false);
            }
            async logout() {
                await fetch(this.#sessionServiceEndpoint + '/api/Logout', { credentials: "include" });
                this.#jwt = null;
            }
            async fetch(endpoint, options) {
                if (!this.authorized) throw new Error('Unauthorized');
                if (this.claims.exp * 1000 < new Date()) await this.login();

                options = options || {};
                options.headers = options.headers || {};
                options.headers["Authorization"] = "Bearer " + this.#jwt;
                return await fetch(endpoint, options).then(async r => {
                    if (r.headers.has("Authorization")) {
                        var header = r.headers.get("Authorization");
                        this.#jwt = header.substring(7);
                        if (this.#sessionIssuer != this.claims.iss) await this.login();
                    }
                    return r;
                });
            }
            get authorized() { return !!this.#jwt; }
            get claims() { if (this.authorized) return JSON.parse(atob(this.#jwt.split('.')[1])); }
        }
    </script>
</head>
<body style="background: #314e30; color: #ffd800">
    <code>This page is useless without developer tools.</code>
    <script type="text/javascript">
        console.log('To be honest, it is pretty useless in the developer tools too... To get anything done use the console here.');
        console.log('E.g: "let client = await CreateClient();"');

        async function GetJWTFromDeveloperAuthorizer(userName) {
            userName ||= 'DevMan123';
            let jwt = await fetch('https://localhost:7022/api/DevJWT/' + userName).then(r => r.text());
            return jwt;
        };

        async function SendJWTToSessionService(jwt) {
            let session = await fetch('https://localhost:7060/api/Login', { credentials: "include", headers: { Authorization: "Bearer " + jwt } }).then(r => r.json());
            return session;
        };

        async function CreateClient(userName) {
            var client = new JWTClient('https://localhost:7060');
            if (!await client.login()) {
                userName ||= 'DevMan123';
                console.log('Fetching new JWT from Developer authorizer using username ' + userName);
                let jwt = await GetJWTFromDeveloperAuthorizer(userName);
                await client.login(jwt);
            }
            if (userName && userName != client.claims.unique_name)
                console.warn('Warning: The session username does not match the requested username.');

            console.log('Sucess! Your client is ready - you can now do authorized requests!"');
            console.log('E.g. await client.fetch("/authorized").then(r => r.text());// which will echo your username.');
            return client;
        }

    </script>
</body>
</html>